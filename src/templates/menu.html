<!DOCTYPE html>
<html lang="en" class="{{themeClass}}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ludus Games</title>
    {{commonCSS}}
    {{themeCSS}}
    {{gameCSS:menu}}
</head>

<body class="menu-page">
    <div class="header-center">
        <button class="settings-btn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
        <img src="{{logoUri}}" alt="Ludus" class="logo">
        <h1>Ludus Games</h1>
        <p class="subtitle">Minimalist games for VS Code</p>
    </div>

    <div class="search-container">
        <span class="search-icon">üîç</span>
        <input type="text" id="searchInput" class="search-input" placeholder="Search games..." onkeyup="filterGames()">
    </div>

    <div id="favoritesSection" class="section">
        <div class="section-title">
            ‚≠ê Favorites
            <span id="favoritesCount" class="count">0</span>
        </div>
        <div id="favoritesGrid" class="menu-grid">
            <div class="no-results">No favorites yet!</div>
        </div>
    </div>

    <div id="allGamesSection" class="section">
        <div class="section-title">
            üéÆ All Games
            <span id="allGamesCount" class="count">0</span>
        </div>
        <div id="allGamesGrid" class="menu-grid">
            <!-- Games will be populated by JavaScript -->
        </div>
    </div>

    <script>
        const GAMES_CONFIG = {{ gamesConfig }};
        let favorites = JSON.parse(localStorage.getItem('ludus-favorites') || '[]');

        function initializeMenu() {
            populateGames();
            updateFavorites();
            updateCounts();
        }

        function populateGames() {
            const allGamesGrid = document.getElementById('allGamesGrid');
            allGamesGrid.innerHTML = '';

            GAMES_CONFIG.forEach(game => {
                const gameCard = createGameCard(game);
                allGamesGrid.appendChild(gameCard);
            });
        }

        function createGameCard(game) {
            const card = document.createElement('div');
            card.className = 'game-card';

            const isFavorite = favorites.includes(game.id);

            card.innerHTML = `
                <div class="game-card-content" onclick="openGame('${game.id}')">
                    <div class="game-card-title">${game.emoji} ${game.name}</div>
                    <div class="game-card-description">${game.description || ''}</div>
                </div>
                <button class="favorite-btn ${isFavorite ? 'favorited' : ''}" 
                        onclick="event.stopPropagation(); toggleFavorite('${game.id}')" 
                        title="${isFavorite ? 'Remove from favorites' : 'Add to favorites'}">
                    ${isFavorite ? '‚≠ê' : '‚òÜ'}
                </button>
            `;

            return card;
        }

        function openGame(gameId) {
            const message = { type: 'playGame', game: gameId };

            if (typeof acquireVsCodeApi !== 'undefined') {
                const vscode = acquireVsCodeApi();
                vscode.postMessage(message);
            } else {
                console.log('Would open game:', gameId);
            }
        }

        function toggleFavorite(gameId) {
            const index = favorites.indexOf(gameId);
            if (index === -1) {
                favorites.push(gameId);
            } else {
                favorites.splice(index, 1);
            }

            localStorage.setItem('ludus-favorites', JSON.stringify(favorites));

            // Refresh the display
            populateGames();
            updateFavorites();
            updateCounts();
        }

        function updateFavorites() {
            const favoritesGrid = document.getElementById('favoritesGrid');

            if (favorites.length === 0) {
                favoritesGrid.innerHTML = '<div class="no-results">No favorites yet!</div>';
                return;
            }

            favoritesGrid.innerHTML = '';
            favorites.forEach(gameId => {
                const game = GAMES_CONFIG.find(g => g.id === gameId);
                if (game) {
                    const gameCard = createGameCard(game);
                    favoritesGrid.appendChild(gameCard);
                }
            });
        }

        function updateCounts() {
            document.getElementById('favoritesCount').textContent = favorites.length;
            document.getElementById('allGamesCount').textContent = GAMES_CONFIG.length;
        }

        function filterGames() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const allCards = document.querySelectorAll('#allGamesGrid .game-card');
            let visibleCount = 0;

            allCards.forEach(card => {
                const title = card.querySelector('.game-card-title').textContent.toLowerCase();
                const description = card.querySelector('.game-card-description').textContent.toLowerCase();

                if (title.includes(searchTerm) || description.includes(searchTerm)) {
                    card.style.display = '';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            // Handle no results message
            const allGamesGrid = document.getElementById('allGamesGrid');
            let noResults = allGamesGrid.querySelector('.no-results');

            if (visibleCount === 0 && searchTerm) {
                if (!noResults) {
                    noResults = document.createElement('div');
                    noResults.className = 'no-results';
                    allGamesGrid.appendChild(noResults);
                }
                noResults.textContent = `No games found for "${searchTerm}"`;
            } else if (noResults) {
                noResults.remove();
            }
        }

        function openSettings() {
            const message = { command: 'openSettings' };

            if (typeof acquireVsCodeApi !== 'undefined') {
                const vscode = acquireVsCodeApi();
                vscode.postMessage(message);
            } else {
                console.log('Would open settings');
            }
        }

        // Handle messages from extension
        if (typeof acquireVsCodeApi !== 'undefined') {
            window.addEventListener('message', event => {
                const message = event.data;
                if (message.type === 'clearFavorites') {
                    favorites = [];
                    localStorage.setItem('ludus-favorites', JSON.stringify(favorites));
                    populateGames();
                    updateFavorites();
                    updateCounts();
                }
            });
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeMenu);
    </script>
</body>

</html>